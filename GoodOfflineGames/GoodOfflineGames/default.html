<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>GOG.com collection</title>
    <meta name="viewport" content="width=device-width" />
    <style>
        * {
            font-family: -apple-system, "Segoe UI";
            font-size: 16px;
            box-sizing: border-box;
            margin: 0;
        }

        body {
            background: #212121;
            padding: 0em;
            margin: 0 1em;
        }

        a {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 0.25em 0.5em;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        .container {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            overflow: auto;
            padding: 1em;
            background: inherit;
            cursor: default;
        }

        #productsContainer,
        #searchResults {
            top: 4em;
            padding-top: 0;
        }

        .product {
            line-height: 2em;
            margin-right: 2em;
            cursor: pointer;
            color: #BDBDBD;
            display: inline-block;
        }

        .wishlisted {
            color: #FFC107;
            font-style: italic;
        }

        .owned {
            color: #66BB6A;
        }

        .partOwned {
            color: #A5D6A7;
            font-style: italic;
        }

        .bundle {
            font-weight: 600;
        }

            .bundle.owned {
                color: #2E7D32;
            }

            .bundle.wishlisted {
                /* wishlisted bundle should be normal
                    to distinguish with partial owned */
                font-style: normal;
            }

        .updated::after {
            content: "*";
            margin-left: 0.1em;
            color: #F44336;
        }

        .dlc::after {
            content: "DLC";
            background: #9C27B0;
            border-radius: 0.2em;
            padding: 0.1em 0.25em;
            margin-left: 0.5em;
            font-size: 0.6em;
            vertical-align: top;
            color: white;
        }

        #searchContainer {
            bottom: auto;
            height: 4em;
        }

            #searchContainer #searchInput {
                padding: 0.25em;
                height: 1.75em;
                border: none;
            }

            #searchContainer a {
                margin-left: 1em;
            }

            #searchContainer #backToTop,
            #searchContainer #toggleLegend {
                float: right;
            }

            #searchContainer #toggleLegend {
                margin-right: 1em;
            }

        #gameDetailsContainer {
            color: #BDBDBD;
        }

            #gameDetailsContainer .cdKey {
                color: #212121;
            }

                #gameDetailsContainer .cdKey:focus {
                    background: inherit;
                }

            #gameDetailsContainer img {
                width: 192px;
                height: 110px;
                border: 0;
                display: inline-block;
                margin-bottom: 1em;
            }


            #gameDetailsContainer .header1 {
                font-size: 2em;
                font-weight: 200;
                margin: 1em 0;
            }

                #gameDetailsContainer .header1.bundle {
                    font-weight: normal;
                }

            #gameDetailsContainer .dlcContainer .header1,
            #gameDetailsContainer .bundleContainer .header1 {
                font-size: 1.5rem;
            }

            #gameDetailsContainer .bundleContainer .dlcContainer .header1 {
                font-size: 1.25em;
            }

            #gameDetailsContainer .header {
                line-height: 1.5em;
                padding-right: 0.75em;
            }

            #gameDetailsContainer .openFolder {
                display: block;
                margin-top: 1em;
            }

        #legendContainer {
            top: 4em;
            left: auto;
            padding-top: 0;
            border-left: solid 1px #424242;
        }

            #legendContainer .product {
                display: block;
                cursor: default;
            }

    </style>
</head>

<body>

    <div id="searchContainer" class="container">
        <input id="searchInput" type="search" placeholder="Type to search..." tabindex="0" />
        <a id="showAllSearchResults" class="hidden" href="#">
            Show all <span class="resultsCount"></span> results...
        </a>
        <button id="backToTop">Top</button>
        <button id="toggleLegend">Legend</button>
    </div>
    <div id="productsContainer" class="container"></div>
    <div id="searchResults" class="container hidden"></div>
    <div id="legendContainer" class="container hidden">
        <div class="product">Available product</div>
        <div class="product owned">Owned product</div>
        <div class="product owned updated">Updated product</div>
        <div class="product wishlisted">Wishlisted product</div>
        <div class="product bundle">Bundle</div>
        <div class="product bundle partOwned">Partially owned bundle</div>
        <div class="product bundle partOwned updated">Updated partially owned bundle</div>
        <div class="product bundle owned">Owned bundle</div>
        <div class="product bundle owned updated">Updated bundle</div>
        <div class="product bundle wishlisted">Wishlisted bundle</div>
        <div class="product dlc">Downloadable content</div>
        <div class="product dlc owned">Owned Downloadable content</div>
        <div class="product dlc wishlisted">Wishlisted Downloadable content</div>
    </div>
    <div id="gameDetailsContainer" class="container hidden">
        <button id="close">Close</button>
        <div id="details"></div>
    </div>
    <script src="./products.js"></script>
    <script src="./owned.js"></script>
    <script src="./updated.js"></script>
    <script src="./wishlisted.js"></script>
    <script src="./productsdata.js"></script>
    <script src="./gamedetails.js"></script>
    <script src="./bundles.js"></script>
    <script>

        "use strict";

        var DEBUG = false;

        var $ = function (id) {
            return document.getElementById(id);
        }

        var Templates = function () {
            var getProductTemplate = function () {
                return "<span class='product {{productClass}}' data-id='{{id}}'>" +
                  "<span class='title' title='{{title}}' >{{title}}</span>" +
                  "</span>";
            }
            var getGameDetailsTemplate = function () {
                return "<div class='productTitle header1 {{productClass}}'>{{productTitle}}</div>" +
                    "<img class='image {{productImageClass}}' srcset='{{productImage}}' />" +
                    "<table border='0' cellspacing='0' cellpadding='0'>" +
                    "<tr class='{{developerClass}}'><td class='header'>Developer</td><td class='title'>{{developerTitle}}</td></tr>" +
                    "<tr class='{{publisherClass}}'><td class='header'>Publisher</td><td class='title'>{{publisherTitle}}</td></tr>" +
                    "<tr class='{{worksOnClass}}'><td class='header'>Works on</td><td class='title'>{{worksOnTitle}}</td></tr>" +
                    "<tr class='{{genresClass}}'><td class='header'>Genres</td><td class='title'>{{genresTitle}}</td></tr>" +
                    "<tr class='{{seriesClass}}'><td class='header'>Series</td><td class='title'>{{seriesTitle}}</td></tr>" +
                    "<tr class='{{cdKeyClass}}'><td class='header'>CD Key</td><td class='title cdKey' title='Select to reveal'>{{cdKeyTitle}}</td></tr>" +
                    "<tr class='{{requiredProductsClass}}'><td class='header'>Required products</td><td class='title'>{{requiredProductsTitle}}</td></tr>" +
                    "</table>" +
                    "<a href='./{{openFolderLink}}/' class='openFolder {{openFolderClass}}'>Open folder...</a>";
            }
            var getDLCsTemplate = function () {
                return "<div class='dlcTitle header1 {{dlcClass}}'>Downloadable content</div>" +
                    "<div class='dlcContainer {{dlcClass}}'>{{dlcContent}}</div>";
            }
            var getBundleTemplate = function () {
                return "<div class='bundleTitle header1 {{bundleClass}}'>Bundled products</div>" +
                    "<div class='bundleContainer {{bundleClass}}'>{{bundleContent}}</div>";
            }
            var getRequiredProductTemplate = function () {
                return "<a data-id='{{id}}'>{{title}}</a>"
            }
            return {
                "getProductTemplate": getProductTemplate,
                "getGameDetailsTemplate": getGameDetailsTemplate,
                "getRequiredProductTemplate": getRequiredProductTemplate,
                "getDLCsTemplate": getDLCsTemplate,
                "getBundleTemplate": getBundleTemplate
            }
        }();

        var Views = function () {
            var bindTemplateToModel = function (template, model) {
                var result = template;
                for (var property in model) {
                    var replacedProperty = "{{" + property + "}}";
                    while (result.indexOf(replacedProperty) > -1)
                        result = result.replace(replacedProperty, model[property]);
                }
                return result;
            }
            var createView = function (model, viewModelProvider, templateProvider) {
                var viewModel = viewModelProvider(model);
                var template = templateProvider();
                return bindTemplateToModel(template, viewModel);
            }
            return {
                "createView": createView
            }
        }();

        var Images = function () {
            var getRelativeUri = function (absoluteUri) {
                var imageParts = absoluteUri.split("/");
                var imageLocalUri = imageParts[imageParts.length - 1];
                return "_images/" + imageLocalUri + "_196.jpg 1x, _images/" + imageLocalUri + "_392.jpg 2x";
            }
            return {
                "getRelativeUri": getRelativeUri
            }
        }();

        var GameDetails = function () {
            var pIndex;
            var pdIndex;
            var gdIndex;
            var gameDetailsContainer = $("gameDetailsContainer");
            var details = gameDetailsContainer.querySelector("#details");
            var closeButton = gameDetailsContainer.querySelector("#close");
            var showDLC = function (id) {
                // add DLC. Showing only 1st level of DLCs to avoid recursion
                var dlcContent = [];
                var dlcProducts = [];
                var processedDlcs = [];

                var pd = pdIndex.getElementByKey(id);
                if (pd && pd.dlcs)
                    for (var ii = 0; ii < pd.dlcs.length; ii++) {
                        dlcProducts.push(pd.dlcs[ii]);
                        processedDlcs.push(pd.dlcs[ii].id);
                    }


                var gd = gdIndex.getElementByKey(id);
                if (gd && gd.dlcs)
                    for (var ii = 0; ii < gd.dlcs.length; ii++) {
                        if (processedDlcs.indexOf(gd.dlcs[ii].id) > -1) continue;
                        dlcProducts.push(gd.dlcs[ii]);
                        processedDlcs.push(gd.dlcs[ii].id);
                    }


                for (var ii = 0; ii < dlcProducts.length; ii++) {
                    dlcContent.push(Views.createView(dlcProducts[ii],
                            ViewModelProvider.getGameDetailsViewModel,
                            Templates.getGameDetailsTemplate));
                }

                return Views.createView(dlcContent,
                    ViewModelProvider.getDLCsViewModel,
                    Templates.getDLCsTemplate);
            }
            var show = function (id, fromId) {
                var product = pIndex.getElementByKey(id);
                if (!product) return;

                var htmlView = Views.createView(product,
                    ViewModelProvider.getGameDetailsViewModel,
                    Templates.getGameDetailsTemplate);

                details.innerHTML = htmlView;
                details.innerHTML += showDLC(id);

                // show bundled products
                if (Bundles.isParent(id)) {
                    var bundleContent = [], bundleClass;

                    var bundle = Bundles.getBundleByParentId(id);
                    for (var ii = 0; ii < bundle.children.length; ii++) {
                        var product = pIndex.getElementByKey(bundle.children[ii]);

                        var productView = Views.createView(product,
                            ViewModelProvider.getGameDetailsViewModel,
                            Templates.getGameDetailsTemplate);
                        var dlcView = showDLC(bundle.children[ii]);

                        bundleContent.push(productView + dlcView);
                    }

                    var bundleView = Views.createView(bundleContent,
                        ViewModelProvider.getBundleViewModel,
                        Templates.getBundleTemplate);

                    details.innerHTML += bundleView;
                }

                var requiredProducts = details.querySelectorAll("a[data-id]");
                initElements(requiredProducts, id);

                closeButton.textContent = (fromId && fromId !== id) ? "Back" : "Close";
                closeButton.addEventListener("click", function () {
                    if (fromId && fromId !== id) show(fromId);
                    else gameDetailsContainer.classList.add("hidden");
                });

                gameDetailsContainer.classList.remove("hidden");
            }
            var init = function (pi, pdi, gdi) {
                pIndex = pi;
                pdIndex = pdi;
                gdIndex = gdi;
            }
            var initElements = function (elements, fromId) {
                for (var ii = 0; ii < elements.length; ii++) {
                    elements[ii].addEventListener("click", function (e) {
                        var id = parseInt(e.currentTarget.getAttribute("data-id"));
                        show(id, fromId);
                        // stop it here, don't propagate to body handler that hides gameDetails containers
                        e.stopPropagation();
                    });
                }
            }
            return {
                "init": init,
                "initElements": initElements
            }
        }();

        var SearchIndex = function () {
            var pIndex, pdIndex, oIndex, uIndex, wIndex;
            var searchIndex = [];
            var indexProduct = function (p) {
                var parts = [];

                if (Bundles.isChild(p.id)) return;
                var pd = pdIndex.getElementByKey(p.id);
                parts.push(p.title.toLowerCase());

                if (pd) {
                    if (DLC.isDLC(pd)) parts.push("dlc");
                    if (pd.publisher) parts.push(pd.publisher.name.toLowerCase());
                    if (pd.developer) parts.push(pd.developer.name.toLowerCase());
                    if (pd.genres) {
                        for (var gg = 0; gg < pd.genres.length; gg++) {
                            parts.push(pd.genres[gg].name.toLowerCase());
                        }
                    }
                }

                if (p.worksOn.Windows) parts.push("windows");
                if (p.worksOn.Mac) parts.push("mac osx");
                if (p.worksOn.Linux) parts.push("linux");

                if (uIndex.check(p.id)) parts.push("updated");
                if (oIndex.check(p.id)) parts.push("owned");
                if (wIndex.check(p.id)) parts.push("wishlisted");

                if (Bundles.isParent(p.id)) {
                    // add child items title
                    var bundle = Bundles.getBundleByParentId(p.id);
                    if (bundle)
                        for (var ii = 0; ii < bundle.children.length; ii++) {
                            var bundleChild = pIndex.getElementByKey(bundle.children[ii]);
                            if (bundleChild) parts.push(bundleChild.title.toLowerCase());
                        }
                }
                searchIndex.push(parts.join(" "));

            }
            var init = function (pi, pdi, oi, ui, wi) {
                pIndex = pi;
                pdIndex = pdi;
                oIndex = oi;
                uIndex = ui;
                wIndex = wi;
                for (var ii = 0; ii < pi.getLength() ; ii++) {
                    indexProduct(pi.getElementByIndex(ii));
                }
            };
            var match = function (text) {
                var textParts = text.split(" ");
                var matchingIds = [];
                for (var ii = 0; ii < searchIndex.length; ii++) {
                    if (!searchIndex[ii]) continue;
                    var matches = true;
                    for (var tt = 0; tt < textParts.length; tt++) {
                        if (!textParts[tt]) continue;
                        matches &= searchIndex[ii].indexOf(textParts[tt]) > -1;
                    }
                    if (matches) matchingIds.push(ii);
                }
                return matchingIds;
            };
            return {
                "init": init,
                "match": match
            }
        }();

        var Search = function () {
            var pIndex;
            var pdIndex;
            var productElements = undefined;
            var searchResults = $("searchResults");
            var productsContainer = $("productsContainer");
            var showAllResultsLink = $("showAllSearchResults");
            var resultsCount = showAllResultsLink.querySelector(".resultsCount");
            var searchResultsLimit = 25;
            var search = function (text, showAllResults) {

                if (productElements === undefined) {
                    productElements = document.querySelectorAll("#productsContainer > .product");
                }

                if (text.length > 0) {

                    searchResults.innerHTML = "";
                    productsContainer.classList.add("hidden");

                    var matchingIndexes = SearchIndex.match(text);
                    var length = showAllResults ? matchingIndexes.length : Math.min(matchingIndexes.length, searchResultsLimit);

                    if (!showAllResults && matchingIndexes.length > searchResultsLimit) {
                        showAllSearchResults.classList.remove("hidden");
                        resultsCount.textContent = matchingIndexes.length;
                    } else {
                        showAllSearchResults.classList.add("hidden");
                    }

                    var clonedProductElements = [];

                    for (var ii = 0; ii < length; ii++) {
                        var clonedProductElement = productElements[matchingIndexes[ii]].cloneNode(true);
                        clonedProductElements.push(clonedProductElement);
                        searchResults.appendChild(clonedProductElement);
                    }

                    GameDetails.initElements(clonedProductElements);

                    searchResults.classList.remove("hidden");

                } else {
                    showAllSearchResults.classList.add("hidden");
                    searchResults.classList.add("hidden");
                    productsContainer.classList.remove("hidden");
                }
            }
            var init = function (pi, pdi) {
                pIndex = pi;
                pdIndex = pdi;
            }
            return {
                "search": search,
                "init": init
            }
        }();


        var DLC = function () {
            var isDLC = function (pd) {
                return (pd &&
                  pd.requiredProducts !== undefined &&
                  pd.requiredProducts.length > 0);
            }
            return {
                "isDLC": isDLC
            }
        }();

        var Owned = function () {
            var pdIndex;
            var gdIndex;
            var oIndex;
            var check = function (id) {

                var ownedProduct = oIndex.getElementByKey(id);
                if (ownedProduct) return true;

                // if all bundled products are owned then bundle is owned
                if (Bundles.isParent(id)) {
                    var bundle = Bundles.getBundleByParentId(id);
                    var childProductsOwned = true;
                    for (var ii = 0; ii < bundle.children.length; ii++) {
                        childProductsOwned &= check(bundle.children[ii]);
                    }
                    if (childProductsOwned) return true;
                }

                var productData = pdIndex.getElementByKey(id);

                // return false because if that is not DLC, we should have passed the check earlier
                if (!DLC.isDLC(productData)) return false;

                for (var rp = 0; rp < productData.requiredProducts.length; rp++) {
                    var requiredProduct = productData.requiredProducts[rp].id;

                    var gameDetails = gdIndex.getElementByKey(requiredProduct);

                    if (!gameDetails ||
                      !gameDetails.dlcs) continue;

                    if (gameDetails.dlcs.length === 0) continue;

                    for (var dd = 0; dd < gameDetails.dlcs.length; dd++) {
                        var dlc = gameDetails.dlcs[dd];
                        if (dlc.title === productData.title) return true;
                    }
                }
            }
            var checkPartialOwnership = function (id) {
                if (Bundles.isParent(id) &&
                  Bundles.checkChildrenAny(id, check)) return true;
            }
            var init = function (pdi, gdi, oi) {
                pdIndex = pdi;
                gdIndex = gdi;
                oIndex = oi;
            }
            return {
                "check": check,
                "checkPartialOwnership": checkPartialOwnership,
                "init": init
            }
        }();

        var ProductClass = function () {
            var pdIndex, wIndex, uIndex;
            var getClass = function (product) {
                var productClass = [];

                if (Owned && Owned.check(product.id)) {
                    productClass.push("owned");
                } else if (owned &&
                  Owned.checkPartialOwnership &&
                  Owned.checkPartialOwnership(product.id)) {
                    productClass.push("partOwned");
                }

                if (wIndex.check(product.id)) productClass.push("wishlisted");
                if (uIndex.check(product.id)) productClass.push("updated");

                var pd = pdIndex.getElementByKey(product.id);
                if (pd && DLC.isDLC(pd)) productClass.push("dlc");

                if (Bundles.isParent(product.id)) productClass.push("bundle");

                return productClass;
            }
            var init = function (pdi, ui, wi) {
                pdIndex = pdi;
                wIndex = wi;
                uIndex = ui;
            }
            return {
                "init": init,
                "getClass": getClass
            }
        }();

        var ViewModelProvider = function () {
            var pdIndex, gdIndex, wIndex, uIndex;
            var getProductViewModel = function (product) {
                var productClass = ProductClass.getClass(product);
                return {
                    "id": product.id,
                    "productClass": productClass.join(" "),
                    "title": (DEBUG) ? product.title + " " + product.id : product.title
                };
            }
            var getRequiredProductViewModel = function (requiredProduct) {
                return requiredProduct;
            }
            var getDLCsViewModel = function (dlcs) {
                return {
                    "dlcContent": dlcs.join(""),
                    "dlcClass": dlcs.length ? "" : "hidden"
                }
            }
            var getBundleViewModel = function (bundles) {
                return {
                    "bundleContent": bundles.join(""),
                    "bundleClass": bundles.length ? "" : "hidden"
                }
            }
            var getGameDetailsViewModel = function (product) {

                var pd = pdIndex.getElementByKey(product.id);
                var gd = gdIndex.getElementByKey(product.id);

                var productClass = ProductClass.getClass(product).join(" ");

                var openFolderLink, openFolderClass = "hidden";
                if (!Bundles.isParent(product.id) &&
                    Owned.check(product.id) &&
                    product.slug) {
                    openFolderLink = product.slug;
                    openFolderClass = "";
                }

                var productImage, productImageClass = "hidden";
                if (product.image) {
                    if (product.image) productImage = Images.getRelativeUri(product.image);
                    if (productImage) productImageClass = "";
                }

                var productTitle = product.title;

                var developerTitle, developerClass = "hidden";
                if (pd &&
                    pd.developer &&
                    pd.developer.name) {
                    developerTitle = pd.developer.name;
                    if (developerTitle) developerClass = "";
                }

                var worksOnTitle, worksOnClass = "hidden";

                if (product.worksOn) {
                    var worksOn = [];
                    if (product.worksOn.Windows) worksOn.push("Windows");
                    if (product.worksOn.Mac) worksOn.push("Mac OS X");
                    if (product.worksOn.Linux) worksOn.push("Linux");

                    worksOnTitle = worksOn.join(", ");
                    if (worksOnTitle) worksOnClass = "";
                }

                var publisherTitle, publisherClass = "hidden";
                if (pd &&
                    pd.publisher &&
                    pd.publisher.name) {
                    publisherTitle = pd.publisher.name;
                    if (publisherTitle) publisherClass = "";
                }

                var seriesTitle, seriesClass = "hidden";

                if (pd &&
                    pd.series &&
                    pd.series.name) {
                    seriesTitle = pd.series.name;
                    if (seriesTitle) seriesClass = "";
                }

                var genresTitle, genresClass = "hidden";
                if (pd &&
                    pd.genres &&
                    pd.genres.length) {
                    var genres = [];
                    for (var ii = 0; ii < pd.genres.length; ii++) {
                        genres.push(pd.genres[ii].name);
                    }
                    genresTitle = genres.join(", ");
                    if (genresTitle) genresClass = "";
                }

                var cdKeyTitle, cdKeyClass = "hidden";
                var cdKeys = [];

                if (gd) {
                    if (gd.cdKey) {
                        cdKeys.push(gd.title + ": " + gd.cdKey);
                    }

                    if (gd.dlcs &&
                        gd.dlcs.length) {
                        for (var ii = 0; ii < gd.dlcs.length; ii++) {
                            if (gd.dlcs[ii].cdKey) {
                                cdKeys.push(gd.dlcs[ii].title + ": " + gd.dlcs[ii].cdKey);
                            }
                        }
                    }

                    cdKeyTitle = cdKeys.join(", ");

                    if (cdKeyTitle) cdKeyClass = "";
                }

                var requiredProductsTitle, requiredProductsClass = "hidden";
                if (pd &&
                    pd.requiredProducts &&
                    pd.requiredProducts.length) {
                    var requiredProducts = [];
                    for (var ii = 0; ii < pd.requiredProducts.length; ii++) {
                        var requiredProductView = Views.createView(pd.requiredProducts[ii],
                            getRequiredProductViewModel,
                            Templates.getRequiredProductTemplate);
                        requiredProducts.push(requiredProductView);
                    }
                    requiredProductsTitle = requiredProducts.join(", ");
                    if (requiredProductsTitle) requiredProductsClass = "";
                }

                return {
                    "openFolderLink": openFolderLink,
                    "openFolderClass": openFolderClass,
                    "productTitle": productTitle,
                    "productClass": productClass,
                    "productImage": productImage,
                    "productImageClass": productImageClass,
                    "worksOnTitle": worksOnTitle,
                    "worksOnClass": worksOnClass,
                    "developerTitle": developerTitle,
                    "developerClass": developerClass,
                    "publisherTitle": publisherTitle,
                    "publisherClass": publisherClass,
                    "seriesTitle": seriesTitle,
                    "seriesClass": seriesClass,
                    "cdKeyTitle": cdKeyTitle,
                    "cdKeyClass": cdKeyClass,
                    "genresTitle": genresTitle,
                    "genresClass": genresClass,
                    "requiredProductsTitle": requiredProductsTitle,
                    "requiredProductsClass": requiredProductsClass
                    //"dlcClass": dlcClass,
                    //"dlcContent": dlcContent
                }
            }
            var init = function (pdi, gdi, ui, wi) {
                pdIndex = pdi;
                gdIndex = gdi;
                wIndex = wi;
                uIndex = ui;
            }
            return {
                "init": init,
                "getProductViewModel": getProductViewModel,
                "getGameDetailsViewModel": getGameDetailsViewModel,
                "getDLCsViewModel": getDLCsViewModel,
                "getBundleViewModel": getBundleViewModel
            }
        }();

        var IndexedCollection = function () {
            var indexKeys = function (collection, getElementKey) {
                var index = [];
                collection.forEach(function (i) {
                    index[getElementKey(i)] = collection.indexOf(i);
                });
                return index;
            }
            var create = function (collection, getElementKey) {
                var index = indexKeys(collection, getElementKey);
                var getElementByKey = function (key) {
                    return collection[index[key]];
                }
                var getElementByIndex = function (itemIndex) {
                    return collection[itemIndex];
                }
                var check = function (id) {
                    if (Bundles &&
                      Bundles.isParent &&
                      Bundles.isParent(id) &&
                      Bundles.checkChildrenAny &&
                      Bundles.checkChildrenAny(id, check)) return true;

                    return getElementByKey(id) !== undefined;
                }
                return {
                    "getElementByKey": getElementByKey,
                    "getElementByIndex": getElementByIndex,
                    "check": check,
                    "getLength": function () {
                        return collection.length
                    }
                }
            }
            return {
                "create": create
            }
        }();

        var Bundles = function () {
            var parents = [];
            var children = [];
            var init = function () {
                if (!bundles || !bundles.length) return;
                for (var ii = 0; ii < bundles.length; ii++) {
                    parents.push(bundles[ii].parent);
                    for (var jj = 0; jj < bundles[ii].children.length; jj++) {
                        children.push(bundles[ii].children[jj]);
                    }
                }
            }
            var isParent = function (id) {
                return parents.indexOf(id) > -1;
            }
            var isChild = function (id) {
                return children.indexOf(id) > -1;
            }
            var getBundleByParentId = function (id) {
                for (var ii = 0; ii < bundles.length; ii++) {
                    if (bundles[ii].parent === id) {
                        return bundles[ii];
                    }
                }
            }
            var checkChildrenAny = function (id, predicate) {
                return checkChildrenInternal(id, predicate, false, function (a, b) {
                    return a | b;
                });
            }
            var checkChildrenAll = function (id, predicate) {
                return checkChildrenInternal(id, predicate, true, function (a, b) {
                    return a & b;
                });
            }
            var checkChildrenInternal = function (id, predicate, initialValue, comparison) {
                var bundle = getBundleByParentId(id);
                var result = initialValue;
                for (var ii = 0; ii < bundle.children.length; ii++) {
                    result = comparison(result, predicate(bundle.children[ii]));
                }
                return result;
            }
            return {
                "init": init,
                "isParent": isParent,
                "isChild": isChild,
                "getBundleByParentId": getBundleByParentId,
                "checkChildrenAny": checkChildrenAny,
                "checkChildrenAll": checkChildrenAll
            }
        }();

        document.addEventListener("DOMContentLoaded", function () {

            var getId = function (e) {
                return e.id
            };

            var getValue = function (e) {
                return e;
            }

            var start = new Date();
            var cp = [];
            var addedProducts = [];

            // first add available products...
            for (var ii = 0; ii < products.length; ii++) {
                cp.push(products[ii]);
                addedProducts.push(products[ii].id);
            }
            // ...then add owned products that are no longer available
            for (var ii = 0; ii < owned.length; ii++) {
                if (addedProducts.indexOf(owned[ii].id) > -1) continue;
                cp.push(owned[ii]);
            }

            var elapsed = new Date() - start;
            console.log("Combining products: " + elapsed + "ms");

            start = new Date();
            var productsIndex = IndexedCollection.create(cp, getId);
            var productsDataIndex = IndexedCollection.create(productsdata, getId);
            var gameDetailsIndex = IndexedCollection.create(gamedetails, getId);
            var ownedIndex = IndexedCollection.create(owned, getId);
            var updatedIndex = IndexedCollection.create(updated, getValue);
            var wishlistedIndex = IndexedCollection.create(wishlisted, getValue);

            ProductClass.init(productsDataIndex, updatedIndex, wishlistedIndex);
            ViewModelProvider.init(productsDataIndex, gameDetailsIndex, updatedIndex, wishlistedIndex);
            Owned.init(productsDataIndex, gameDetailsIndex, ownedIndex);
            elapsed = new Date() - start;
            console.log("Indexing collections: " + elapsed + "ms");

            start = new Date();
            Bundles.init();
            elapsed = new Date() - start;
            console.log("Initializing bundles: " + elapsed + "ms");

            start = new Date();
            var html = [];
            for (var ii = 0; ii < productsIndex.getLength() ; ii++) {
                var product = productsIndex.getElementByIndex(ii);

                if (Bundles.isChild(product.id)) continue;

                var view = Views.createView(product,
                  ViewModelProvider.getProductViewModel,
                  Templates.getProductTemplate);
                html.push(view);
            }
            elapsed = new Date() - start;
            console.log("Creating views: " + elapsed + "ms");

            var start = new Date();
            // show first N elements ASAP, others delay for a bit
            var throttle = Math.min(150, html.length);
            var initialHtml = html.slice(0, throttle).join("");
            var pContainer = document.getElementById("productsContainer");
            pContainer.innerHTML = initialHtml;

            var remainingHtml = html.slice(throttle, html.length).join("");
            requestAnimationFrame(function () {
                pContainer.innerHTML += remainingHtml;

                start = new Date();
                var productsElements = document.querySelectorAll("#productsContainer > .product");
                GameDetails.init(productsIndex, productsDataIndex, gameDetailsIndex);
                GameDetails.initElements(productsElements);
                elapsed = new Date() - start;
                console.log("Initializing game details: " + elapsed + "ms");
            });
            var elapsed = new Date() - start;
            console.log("Adding html to the DOM: " + elapsed + "ms");

            start = new Date();
            SearchIndex.init(
              productsIndex,
              productsDataIndex,
              ownedIndex,
              updatedIndex,
              wishlistedIndex);
            elapsed = new Date() - start;
            console.log("Initializing search index: " + elapsed + "ms");

            Search.init(productsIndex, productsDataIndex);
            var searchInput = $("searchInput");
            searchInput.addEventListener("input", function (e) {
                Search.search(searchInput.value.toLowerCase())
            });

            var showAllSearchResults = $("showAllSearchResults");
            showAllSearchResults.addEventListener("click", function () {
                Search.search(searchInput.value.toLowerCase(), true);
            });

            var toggleLegend = $("toggleLegend");
            toggleLegend.addEventListener("click", function (e) {
                var legendContainer = $("legendContainer");
                legendContainer.classList.toggle("hidden");
                e.preventDefault();
            });

            var backToTop = $("backToTop");
            backToTop.addEventListener("click", function () {
                var productsContainer = $("productsContainer");
                var searchResults = $("searchResults");

                if (!searchResults.classList.contains("hidden")) {
                    searchResults.scrollTop = 0;
                } else {
                    productsContainer.scrollTop = 0;
                }
            });
        });
    </script>
</body>

</html>
