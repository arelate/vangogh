<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>GOG.com collection</title>
    <meta name="viewport" content="width=device-width" />
    <style>
        * {
            font-family: -apple-system, "Segoe UI";
            font-size: 16px;
            box-sizing: border-box;
            margin: 0;
        }

        body {
            background: #212121;
            padding: 0em;
            margin: 0 1em;
        }

        a {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        button {
            background: #2196f3;
            color: white;
            border: 1px solid #1976d2;
            border-radius: 4px;
            padding: 0 1em;
            margin: 0;
            cursor: pointer;
            box-shadow: inset 0px 1px 0px rgba(255,255,255,0.2);
            text-shadow: 0px 1px 0px rgba(0,0,0,0.2);
            font-size: 0.8em;
            height: 30px;
        }

            button:hover {
                background: #1976d2;
                border-color: #0d47a1;
            }

        input[type=search] {
            padding: 4px;
            height: 30px;
            border: 1px solid #616161;
            border-radius: 4px;
            font-size: 0.8em;
            box-shadow: inset 0px 1px 1px rgba(0,0,0,0.075);
            color: #212121;
        }

            input[type=search]:focus {
                border-color: #1976d2;
                box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, 0.6);
            }

        .hidden {
            display: none !important;
        }

        .container {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            overflow: auto;
            padding: 1em;
            background: inherit;
            cursor: default;
        }

        #productsContainer,
        #searchResults {
            top: 4em;
            padding-top: 0;
        }

        .product {
            line-height: 2em;
            margin-right: 2em;
            cursor: pointer;
            color: #BDBDBD;
            display: inline-block;
        }

        .productContainer {
            display: inline-block;
            margin-right: 1em;
            margin-bottom: 1em;
            max-width: 800px;
            vertical-align: top;
        }

        .wishlisted {
            color: #FFC107;
            font-style: italic;
        }

        .owned {
            color: #66BB6A;
        }

        .partOwned {
            color: #A5D6A7;
            font-style: italic;
        }

        .bundle {
            font-weight: 600;
        }

            .bundle.owned {
                color: #2E7D32;
            }

            .bundle.wishlisted {
                /* wishlisted bundle should be normal
                    to distinguish with partial owned */
                font-style: normal;
            }

        .updated::after {
            content: "*";
            margin-left: 0.1em;
            color: #F44336;
        }

        .dlc::after {
            content: "DLC";
            background: #9C27B0;
            border-radius: 0.2em;
            padding: 0.1em 0.25em;
            margin-left: 0.5em;
            font-size: 0.6em;
            vertical-align: top;
            color: white;
        }

        #searchContainer {
            bottom: auto;
            height: 4em;
        }


            #searchContainer a {
                margin-left: 1em;
            }

            #searchContainer #backToTop,
            #searchContainer #toggleLegend {
                float: right;
            }

            #searchContainer #toggleLegend {
                margin-right: 1em;
            }

        #gameDetailsContainer {
            color: #BDBDBD;
        }

            #gameDetailsContainer #details {
                position: fixed;
                top: 4em;
                padding-bottom: 1em;
            }

            #gameDetailsContainer .cdKey {
                color: #212121 !important;
            }

                #gameDetailsContainer .cdKey:focus {
                    background: inherit;
                }

            #gameDetailsContainer img {
                width: 800px;
                height: 370px;
                border: 0;
                display: inline-block;
                margin-bottom: 1em;
            }


            #gameDetailsContainer .header1 {
                font-size: 2em;
                font-weight: 200;
                margin-bottom: 1em;
            }

                #gameDetailsContainer .header1.bundle {
                    font-weight: normal;
                }

            #gameDetailsContainer .dlcContainer .header1,
            #gameDetailsContainer .bundleContainer .header1 {
                font-size: 1.5rem;
            }

            #gameDetailsContainer .bundleContainer .dlcContainer .header1 {
                font-size: 1.25em;
            }

            #gameDetailsContainer .header {
                line-height: 1.5em;
                padding-right: 0.75em;
                min-width: 5em;
            }

            #gameDetailsContainer .openFolder {
                display: block;
                margin-top: 1em;
            }

            #gameDetailsContainer td.title {
                color: white;
            }

            #gameDetailsContainer td svg {
                width: 1.5em;
                height: 1.5em;
                padding: 0.5em 0.2em 0 0;
            }

        #legendContainer {
            top: 4em;
            left: auto;
            padding-top: 0;
            border-left: solid 1px #424242;
        }

            #legendContainer .product {
                display: block;
                cursor: default;
            }
    </style>
</head>

<body>

    <svg viewBox="0 0 100 100" class="hidden">
        <g id="windows" transform="translate(0,-952.36216)">
            <g transform="matrix(2.6923075,0,0,2.6923075,-691.46883,403.20481)">
                <path fill="white" d="m 272.05451,223.57098 -15.22321,0 0,12.43304 15.22321,2.09821 0,-14.53125 z m 0,-16.58482 -15.22321,2.09821 0,12.61161 15.22321,0 0,-14.70982 z m 21.91965,16.58482 -20.24554,0 0,14.75446 20.24554,2.79018 0,-17.54464 z m 0,-19.59821 -20.24554,2.79017 0,14.93304 20.24554,0 0,-17.72321 z" />
            </g>
        </g>
        <g id="macosx" transform="matrix(1.6666667,0,0,1.6666667,-33.333333,-33.333333)">
            <path stroke="white" stroke-width="1.5px" fill="transparent" d="M 50,79 C 34,79 21,66 21,50 21,34 34,21 50,21 66,21 79,34 79,50 79,66 66,79 50,79 Z" />
            <path stroke="white" stroke-width="1.5px" d="m 62.8,31.6 c -0.2,-0.2 -0.5,-0.1 -0.7,0.1 L 50,49.1 37.9,31.7 c -0.2,-0.2 -0.5,-0.3 -0.7,-0.1 -0.2,0.2 -0.3,0.5 -0.1,0.7 L 49.4,50 37.1,67.7 c -0.2,0.2 -0.1,0.5 0.1,0.7 0.1,0.1 0.2,0.1 0.3,0.1 0.2,0 0.3,-0.1 0.4,-0.2 L 50,50.9 62.1,68.3 c 0.1,0.1 0.3,0.2 0.4,0.2 0.1,0 0.2,0 0.3,-0.1 0.2,-0.2 0.3,-0.5 0.1,-0.7 L 50.6,50 62.9,32.3 c 0.2,-0.2 0.1,-0.6 -0.1,-0.7 z" />
        </g>
        <g id="linux" transform="translate(0,-952.36216)">
            <path fill="white" d="m 44.145438,975.30125 c -1.785848,-0.11162 -1.897463,1.17196 -1.339386,1.11615 0.613886,0 0.223231,-1.00454 1.339386,-1.11615 z m 4.855274,0.78131 c 0.558077,-0.22323 0,-1.33939 -1.618425,-0.61389 1.00454,-0.27904 1.060348,0.78131 1.618425,0.61389 z m -19.588518,23.8299 c 0.446462,0.16744 0.167423,0.66974 -0.111616,1.61844 -0.334846,0.7813 -1.116154,1.451 -1.395193,1.3952 -0.781309,-0.1116 0.223231,-0.6697 0.613885,-1.3952 0.50227,-0.7813 0.390654,-1.78586 0.892924,-1.61844 z m 47.715621,20.03494 c -2.288118,-1.8416 -9.15247,-2.1765 -9.319893,2.2882 -1.227771,0 -2.120695,0.1116 -2.846195,1.0045 -2.790388,3.2927 -0.223231,9.878 -0.50227,13.4497 -0.223231,3.1252 -1.116155,6.1946 -1.562617,9.3199 -1.674232,-0.056 -1.506809,-1.2278 -1.004539,-2.9578 0.502269,-1.5069 1.22777,-3.3485 1.283578,-5.1344 0.05581,-1.6742 -0.111616,-2.6787 -0.558078,-2.902 -0.390654,-0.279 -1.004539,0.2233 -1.897463,1.6743 -1.897463,3.0694 -6.027236,4.4088 -9.877971,4.8552 -3.794926,0.5023 -7.366622,0.1117 -9.264085,-2.009 -0.613885,-0.7255 -1.73004,0.2232 -1.841656,0.3906 -0.167423,0.2791 0.613886,0.7813 1.227771,1.8975 0.892924,1.5626 1.73004,4.0181 -0.390654,5.1343 0.05581,-5.6366 -1.73004,-5.9714 -3.571696,-9.4315 3.571696,-0.3907 4.073965,-4.1856 2.343925,-5.804 -1.339386,-1.3952 -9.040854,-7.0876 -10.994125,-9.3199 -0.948732,-1.0046 -2.23231,-1.5068 -2.73458,-2.6788 -1.22777,-2.6788 -2.064886,-6.5295 -0.558077,-9.2641 0.279039,-0.5022 0.50227,-0.279 0.279039,0.7255 -1.227771,5.8598 2.567156,10.6593 3.404272,8.2038 0.613885,-1.6743 0.05581,-4.6879 0.390654,-7.1434 0.558078,-4.2414 4.408812,-12.44515 6.138852,-12.89161 -2.622964,-4.91108 3.069426,-8.70601 3.013618,-13.00321 -0.05581,-2.79038 2.455541,3.40427 4.966889,4.74366 2.790388,1.451 5.859813,-2.79039 10.212817,-4.91108 1.227771,-0.61389 2.790388,-1.28358 2.678772,-1.84166 -0.50227,-2.51134 -5.69239,3.12524 -10.38024,3.29266 -2.120694,0.0558 -2.902003,-0.44646 -3.739119,-1.22777 -2.455541,-2.39973 0.279039,-0.39065 3.96235,-1.06035 1.618424,-0.27904 2.176502,-0.55807 3.906542,-1.28358 1.785848,-0.66969 3.739119,-1.73004 5.69239,-2.28811 1.395193,-0.33485 1.283578,-1.3952 0.7255,-1.67423 -0.279038,-0.16743 -0.7255,-0.16743 -1.116154,0.44646 -0.837117,1.451 -4.799466,2.28811 -6.027237,2.67877 -1.618424,0.50227 -3.348464,0.94873 -5.69239,0.83711 -3.571695,-0.11161 -2.734579,-1.78584 -5.301735,-3.23684 -0.725501,-0.39066 -0.50227,-1.50681 0.446462,-2.51135 0.558077,-0.50227 1.953271,-0.83712 2.678771,-2.00908 0.111616,-0.16742 1.00454,-1.11616 1.73004,-1.61843 0.223231,-0.16742 0.223231,-4.52042 -1.953271,-4.57623 -1.897463,-0.0558 -2.45554,1.39519 -2.399733,2.84619 0.111616,1.45101 0.892924,2.67878 1.395194,2.67878 1.004539,-0.0558 0.05581,1.06034 -0.50227,1.22777 -0.837116,0.27903 -1.953271,-3.23685 -1.785848,-4.91109 0.111616,-1.78584 1.00454,-4.91108 3.23685,-4.85527 2.009078,0.0558 3.46008,2.56716 3.404272,6.92016 0,0.7255 3.236849,-0.33485 4.353004,0.83712 0.781308,0.78131 -2.678772,-7.70147 5.022697,-8.31536 2.009079,0.39066 3.96235,1.06035 4.743658,5.7482 -0.279039,0.44646 0.50227,3.68331 -0.725501,4.07397 -1.506809,0.50227 -2.45554,-0.0558 -1.562616,-1.50681 0.558077,-1.451 0,-5.13432 -3.069426,-4.91108 -3.125234,0.16742 -2.678772,5.69239 -1.841656,5.804 0.837116,0.11162 2.957811,1.61843 4.46462,1.89746 4.855273,0.94874 1.283578,3.73912 1.897463,7.1434 0.725501,3.79492 3.236849,2.79038 5.524967,12.94739 0.446462,0.61389 2.343925,1.17196 4.18558,8.98504 1.618425,6.976 -0.669693,12.1103 3.23685,11.6638 0.892923,-0.056 2.232309,-0.3348 2.790387,-2.3439 1.451001,-5.1343 -0.781309,-11.329 -3.013618,-15.5146 -1.283579,-2.45549 -2.511349,-4.07392 -3.181042,-4.63199 2.567156,1.50681 5.859813,6.36209 6.641122,9.93379 1.004539,4.7436 1.674232,6.7527 0.167423,11.7754 0.892924,0.3907 3.069426,1.3394 3.069426,2.3439 z M 42.080552,973.79444 c 0,0.16742 -0.111616,0.16742 -0.167424,0.16742 -0.502269,0 -0.558077,-0.44646 -0.446461,-1.11615 0.111615,-0.50227 -0.167424,-0.83712 -0.390655,-0.83712 -0.334846,0.11162 -0.446462,-0.89292 0.223231,-0.7255 0.334847,0.11162 1.00454,1.11616 0.781309,2.51135 z m 23.383444,10.99413 c 0.167424,0.7813 -0.334846,1.67423 -1.004539,1.56261 -1.116155,-0.22323 -3.739119,-2.902 -2.567156,-4.18558 0.390654,-0.39065 0.613885,0.7255 1.674232,1.3952 0.892924,0.55807 1.674232,0.16742 1.897463,1.22777 z m -9.933778,-11.88705 c 0,0.16742 -0.558077,0.39065 -0.558077,0.27903 -0.111616,-0.83711 -0.558078,-1.61842 -1.00454,-1.73004 -0.334846,-0.11161 -0.558077,-0.44646 0.167423,-0.50226 0.279039,-0.0558 1.451002,0.61388 1.395194,1.95327 z m 3.013618,-13.00321 c -0.279039,0.61389 -1.562617,0.44646 -1.841655,0.55808 -1.060348,0.39065 -1.395194,1.39519 -1.897464,1.00454 -0.558077,-0.44646 0.279039,-0.94873 0.50227,-1.56262 0.167423,-0.55808 -0.390654,-1.73004 0.725501,-1.84165 0.446462,0 0.892924,0.39065 1.339386,0.83711 0.502269,0.39066 1.22777,0.7255 1.171962,1.00454 z m 31.531375,74.83819 c -1.562616,-1.0045 -5.357543,-2.0649 -5.69239,-9.3199 -1.451001,1.2836 -1.283578,8.0363 2.73458,9.3757 4.464619,1.5068 7.255007,4.0182 -1.060347,6.8644 -5.469159,1.8974 -6.417891,2.4555 -10.770895,6.083 -4.408811,3.6833 -10.994125,2.2323 -9.822163,-5.4692 0.613886,-4.0739 0.948732,-7.3666 -0.05581,-10.8825 -0.50227,-1.6742 -0.725501,-3.9065 -0.390655,-5.4133 0.613886,-3.0136 2.23231,-3.9066 3.850735,-1.0604 1.004539,1.8417 1.339386,3.9624 4.911081,4.1298 5.580775,0.2232 6.696929,-5.4133 8.482777,-5.6924 1.171963,-0.1674 2.399733,-3.5717 1.506809,-9.0408 -1.004539,-5.8599 -4.464619,-15.06813 -8.873431,-19.75598 -3.683311,-3.90654 -5.971429,-7.31081 -7.42243,-12.16609 -1.22777,-4.12977 -1.897463,-8.09212 -1.674232,-11.94285 0.334846,-4.91109 -2.399733,-11.77544 -6.752737,-15.01229 -2.73458,-2.00908 -7.031776,-3.12523 -10.88251,-3.06942 -2.176502,0 -4.241389,0.33484 -5.804006,1.17196 -6.473698,3.51589 -7.366622,8.53858 -7.255006,14.28678 0.111615,5.35754 0.279038,11.4964 0.892924,17.3004 -0.725501,2.67877 -4.520428,7.75728 -6.920161,10.88251 -3.236849,3.18104 -4.855273,9.37568 -6.975968,14.78908 -1.116154,2.8462 -2.95781,4.1856 -3.125233,7.8689 -0.05581,1.0603 0,3.7391 0.948731,2.9578 3.794927,-2.902 8.538585,4.4646 15.737784,15.7378 1.339386,2.1765 6.19466,11.2731 -2.288117,12.4451 -2.846195,0.3906 -7.42243,-1.6184 -11.831242,-2.7346 -3.96235,-0.9487 -8.036315,-1.5626 -10.268625,-2.1765 -1.3951934,-0.3906 -1.9532709,-0.8929 -2.0648863,-1.451 -0.3348465,-1.5068 1.6742323,-3.6275 1.7300403,-5.4133 0.111615,-1.7859 -0.613885,-2.7346 -1.2277707,-4.1856 -0.6138851,-1.451 -0.7813084,-2.5672 -0.2790387,-3.1811 0.3348465,-0.5022 1.1161554,-0.6697 2.3997334,-0.558 1.618424,0.1674 3.571695,-0.1675 4.632042,-0.8372 1.73004,-1.0603 2.567157,-3.2368 1.785848,-5.9156 0,2.623 -0.892924,3.5717 -3.013618,4.7995 -2.009079,1.1161 -5.078505,0.1674 -6.529506,1.451 -1.6742324,1.451 0.6138851,5.3017 0.4464619,8.1479 -0.1674232,2.1207 -2.399733,4.5762 -1.3951936,6.7528 1.0045394,2.1765 5.7481977,2.4555 10.6592787,3.46 7.031776,1.451 11.105741,4.0182 14.342591,4.1298 4.743658,0.1674 5.469158,-4.5762 12.835781,-4.7437 2.176502,-0.056 4.297196,-0.1674 6.41789,-0.2232 2.399733,0 4.799466,0 7.255007,0.056 4.911081,0.1674 3.236849,2.7346 6.41789,4.353 2.73458,1.3952 7.589853,0.8371 8.761816,-0.279 1.562617,-1.5068 5.804005,-5.0785 8.985047,-6.6969 4.073965,-2.0649 13.505474,-5.5808 6.641121,-9.8222 z" />
        </g>
    </svg>

    <div id="searchContainer" class="container">
        <input id="searchInput" type="search" placeholder="Type to search..." tabindex="0" />
        <a id="showAllSearchResults" class="hidden" href="#">
            Show all <span class="resultsCount"></span> results...
        </a>
        <button id="backToTop">Top</button>
        <button id="toggleLegend">Legend</button>
    </div>
    <div id="productsContainer" class="container"></div>
    <div id="searchResults" class="container hidden"></div>
    <div id="legendContainer" class="container hidden">
        <div class="product">Available product</div>
        <div class="product owned">Owned product</div>
        <div class="product owned updated">Updated product</div>
        <div class="product wishlisted">Wishlisted product</div>
        <div class="product bundle">Bundle</div>
        <div class="product bundle partOwned">Partially owned bundle</div>
        <div class="product bundle partOwned updated">Updated partially owned bundle</div>
        <div class="product bundle owned">Owned bundle</div>
        <div class="product bundle owned updated">Updated bundle</div>
        <div class="product bundle wishlisted">Wishlisted bundle</div>
        <div class="product dlc">Downloadable content</div>
        <div class="product dlc owned">Owned Downloadable content</div>
        <div class="product dlc wishlisted">Wishlisted Downloadable content</div>
    </div>
    <div id="gameDetailsContainer" class="container hidden">
        <button id="close">Close</button>
        <div id="details" class="container"></div>
    </div>
    <script src="./products.js"></script>
    <script src="./owned.js"></script>
    <script src="./updated.js"></script>
    <script src="./wishlisted.js"></script>
    <script src="./productsdata.js"></script>
    <script src="./gamedetails.js"></script>
    <script src="./bundles.js"></script>
    <script>

        "use strict";

        var DEBUG = false;

        var $ = function (id) {
            return document.getElementById(id);
        }

        var Templates = function () {
            var getProductTemplate = function () {
                return "<span class='product {{productClass}}' data-id='{{id}}'>" +
                  "<span class='title' title='{{title}}' >{{title}}</span>" +
                  "</span>";
            }
            var getGameDetailsTemplate = function () {
                return "<div class='productContainer'><div class='productTitle header1 {{productClass}}'>{{productTitle}}</div>" +
                    "<img class='image {{productImageClass}}' srcset='{{productRetinaImage}} 2x, {{productImage}} 1x' src='{{productImage}}' />" +
                    "<table border='0' cellspacing='0' cellpadding='0'>" +
                    "<tr class='{{developerClass}}'><td class='header'>Developer</td><td class='title'>{{developerTitle}}</td></tr>" +
                    "<tr class='{{publisherClass}}'><td class='header'>Publisher</td><td class='title'>{{publisherTitle}}</td></tr>" +
                    "<tr class='{{genresClass}}'><td class='header'>Genres</td><td class='title'>{{genresTitle}}</td></tr>" +
                    "<tr class='{{seriesClass}}'><td class='header'>Series</td><td class='title'>{{seriesTitle}}</td></tr>" +
                    "<tr class='{{cdKeyClass}}'><td class='header'>CD Key</td><td class='title cdKey' title='Select to reveal'>{{cdKeyTitle}}</td></tr>" +
                    "<tr class='{{requiredProductsClass}}'><td class='header'>Required products</td><td class='title'>{{requiredProductsTitle}}</td></tr>" +
                    "<tr class='{{worksOnClass}}'><td class='header'>Works on</td><td class='title'>{{worksOnTitle}}</td></tr>" +
                    "</table>" +
                    "<a href='./{{openFolderLink}}/' class='openFolder {{openFolderClass}}'>Open folder...</a></div>";
            }
            var getDLCsTemplate = function () {
                return "<div class='dlcTitle header1 {{dlcClass}}'>Downloadable content</div>" +
                    "<div class='dlcContainer {{dlcClass}}'>{{dlcContent}}</div>";
            }
            var getBundleTemplate = function () {
                return "<div class='bundleTitle header1 {{bundleClass}}'>Bundled products</div>" +
                    "<div class='bundleContainer {{bundleClass}}'>{{bundleContent}}</div>";
            }
            var getRequiredProductTemplate = function () {
                return "<a data-id='{{id}}'>{{title}}</a>"
            }
            return {
                "getProductTemplate": getProductTemplate,
                "getGameDetailsTemplate": getGameDetailsTemplate,
                "getRequiredProductTemplate": getRequiredProductTemplate,
                "getDLCsTemplate": getDLCsTemplate,
                "getBundleTemplate": getBundleTemplate
            }
        }();

        var Views = function () {
            var bindTemplateToModel = function (template, model) {
                var result = template;
                for (var property in model) {
                    var replacedProperty = "{{" + property + "}}";
                    while (result.indexOf(replacedProperty) > -1)
                        result = result.replace(replacedProperty, model[property]);
                }
                return result;
            }
            var createView = function (model, viewModelProvider, templateProvider) {
                var viewModel = viewModelProvider(model);
                var template = templateProvider();
                return bindTemplateToModel(template, viewModel);
            }
            return {
                "createView": createView
            }
        }();

        var Images = function () {
            var getRelativeUri = function (absoluteUri) {
                var imageParts = absoluteUri.split("/");
                var imageLocalUri = imageParts[imageParts.length - 1];
                return {
                    "productImage": "_images/" + imageLocalUri + "_800.jpg",
                    "productRetinaImage": "_images/" + imageLocalUri + ".jpg"
                }
            }
            return {
                "getRelativeUri": getRelativeUri
            }
        }();

        var GameDetails = function () {
            var pIndex;
            var pdIndex;
            var gdIndex;
            var gameDetailsContainer = $("gameDetailsContainer");
            var details = gameDetailsContainer.querySelector("#details");
            var closeButton = gameDetailsContainer.querySelector("#close");
            var showDLC = function (id) {
                // add DLC. Showing only 1st level of DLCs to avoid recursion
                var dlcContent = [];
                var dlcProducts = [];
                var processedDlcs = [];

                var pd = pdIndex.getElementByKey(id);
                if (pd && pd.dlcs)
                    for (var ii = 0; ii < pd.dlcs.length; ii++) {
                        dlcProducts.push(pd.dlcs[ii]);
                        processedDlcs.push(pd.dlcs[ii].id);
                    }


                var gd = gdIndex.getElementByKey(id);
                if (gd && gd.dlcs)
                    for (var ii = 0; ii < gd.dlcs.length; ii++) {
                        if (processedDlcs.indexOf(gd.dlcs[ii].id) > -1) continue;
                        dlcProducts.push(gd.dlcs[ii]);
                        processedDlcs.push(gd.dlcs[ii].id);
                    }


                for (var ii = 0; ii < dlcProducts.length; ii++) {
                    dlcContent.push(Views.createView(dlcProducts[ii],
                            ViewModelProvider.getGameDetailsViewModel,
                            Templates.getGameDetailsTemplate));
                }

                return Views.createView(dlcContent,
                    ViewModelProvider.getDLCsViewModel,
                    Templates.getDLCsTemplate);
            }
            var show = function (id, fromId) {
                var product = pIndex.getElementByKey(id);
                if (!product) return;

                var htmlView = Views.createView(product,
                    ViewModelProvider.getGameDetailsViewModel,
                    Templates.getGameDetailsTemplate);

                details.innerHTML = htmlView;
                details.innerHTML += showDLC(id);

                // show bundled products
                if (Bundles.isParent(id)) {
                    var bundleContent = [], bundleClass;

                    var bundle = Bundles.getBundleByParentId(id);
                    for (var ii = 0; ii < bundle.children.length; ii++) {
                        var product = pIndex.getElementByKey(bundle.children[ii]);

                        var productView = Views.createView(product,
                            ViewModelProvider.getGameDetailsViewModel,
                            Templates.getGameDetailsTemplate);
                        var dlcView = showDLC(bundle.children[ii]);

                        bundleContent.push(productView + dlcView);
                    }

                    var bundleView = Views.createView(bundleContent,
                        ViewModelProvider.getBundleViewModel,
                        Templates.getBundleTemplate);

                    details.innerHTML += bundleView;
                }

                var requiredProducts = details.querySelectorAll("a[data-id]");
                initElements(requiredProducts, id);

                closeButton.textContent = (fromId && fromId !== id) ? "Back" : "Close";
                closeButton.addEventListener("click", function () {
                    if (fromId && fromId !== id) show(fromId);
                    else gameDetailsContainer.classList.add("hidden");
                });

                gameDetailsContainer.classList.remove("hidden");
            }
            var init = function (pi, pdi, gdi) {
                pIndex = pi;
                pdIndex = pdi;
                gdIndex = gdi;
            }
            var initElements = function (elements, fromId) {
                for (var ii = 0; ii < elements.length; ii++) {
                    elements[ii].addEventListener("click", function (e) {
                        var id = parseInt(e.currentTarget.getAttribute("data-id"));
                        show(id, fromId);
                        // stop it here, don't propagate to body handler that hides gameDetails containers
                        e.stopPropagation();
                    });
                }
            }
            return {
                "init": init,
                "initElements": initElements
            }
        }();

        var SearchIndex = function () {
            var pIndex, pdIndex, oIndex, uIndex, wIndex;
            var searchIndex = [];
            var indexProduct = function (p) {
                var parts = [];

                if (Bundles.isChild(p.id)) return;
                var pd = pdIndex.getElementByKey(p.id);
                parts.push(p.title.toLowerCase());

                if (pd) {
                    if (DLC.isDLC(pd)) parts.push("dlc");
                    if (pd.publisher) parts.push(pd.publisher.name.toLowerCase());
                    if (pd.developer) parts.push(pd.developer.name.toLowerCase());
                    if (pd.genres) {
                        for (var gg = 0; gg < pd.genres.length; gg++) {
                            parts.push(pd.genres[gg].name.toLowerCase());
                        }
                    }
                }

                if (p.worksOn.Windows) parts.push("windows");
                if (p.worksOn.Mac) parts.push("mac osx");
                if (p.worksOn.Linux) parts.push("linux");

                if (uIndex.check(p.id)) parts.push("updated");
                if (oIndex.check(p.id)) parts.push("owned");
                if (wIndex.check(p.id)) parts.push("wishlisted");

                if (Bundles.isParent(p.id)) {
                    // add child items title
                    var bundle = Bundles.getBundleByParentId(p.id);
                    if (bundle)
                        for (var ii = 0; ii < bundle.children.length; ii++) {
                            var bundleChild = pIndex.getElementByKey(bundle.children[ii]);
                            if (bundleChild) parts.push(bundleChild.title.toLowerCase());
                        }
                }
                searchIndex.push(parts.join(" "));

            }
            var init = function (pi, pdi, oi, ui, wi) {
                pIndex = pi;
                pdIndex = pdi;
                oIndex = oi;
                uIndex = ui;
                wIndex = wi;
                for (var ii = 0; ii < pi.getLength() ; ii++) {
                    indexProduct(pi.getElementByIndex(ii));
                }
            };
            var match = function (text) {
                var textParts = text.split(" ");
                var matchingIds = [];
                for (var ii = 0; ii < searchIndex.length; ii++) {
                    if (!searchIndex[ii]) continue;
                    var matches = true;
                    for (var tt = 0; tt < textParts.length; tt++) {
                        if (!textParts[tt]) continue;
                        matches &= searchIndex[ii].indexOf(textParts[tt]) > -1;
                    }
                    if (matches) matchingIds.push(ii);
                }
                return matchingIds;
            };
            return {
                "init": init,
                "match": match
            }
        }();

        var Search = function () {
            var pIndex;
            var pdIndex;
            var productElements = undefined;
            var searchResults = $("searchResults");
            var productsContainer = $("productsContainer");
            var showAllResultsLink = $("showAllSearchResults");
            var resultsCount = showAllResultsLink.querySelector(".resultsCount");
            var searchResultsLimit = 25;
            var search = function (text, showAllResults) {

                if (productElements === undefined) {
                    productElements = document.querySelectorAll("#productsContainer > .product");
                }

                if (text.length > 0) {

                    searchResults.innerHTML = "";
                    productsContainer.classList.add("hidden");

                    var matchingIndexes = SearchIndex.match(text);
                    var length = showAllResults ? matchingIndexes.length : Math.min(matchingIndexes.length, searchResultsLimit);

                    if (!showAllResults && matchingIndexes.length > searchResultsLimit) {
                        showAllSearchResults.classList.remove("hidden");
                        resultsCount.textContent = matchingIndexes.length;
                    } else {
                        showAllSearchResults.classList.add("hidden");
                    }

                    var clonedProductElements = [];

                    for (var ii = 0; ii < length; ii++) {
                        var clonedProductElement = productElements[matchingIndexes[ii]].cloneNode(true);
                        clonedProductElements.push(clonedProductElement);
                        searchResults.appendChild(clonedProductElement);
                    }

                    GameDetails.initElements(clonedProductElements);

                    searchResults.classList.remove("hidden");

                } else {
                    showAllSearchResults.classList.add("hidden");
                    searchResults.classList.add("hidden");
                    productsContainer.classList.remove("hidden");
                }
            }
            var init = function (pi, pdi) {
                pIndex = pi;
                pdIndex = pdi;
            }
            return {
                "search": search,
                "init": init
            }
        }();


        var DLC = function () {
            var isDLC = function (pd) {
                return (pd &&
                  pd.requiredProducts !== undefined &&
                  pd.requiredProducts.length > 0);
            }
            return {
                "isDLC": isDLC
            }
        }();

        var Owned = function () {
            var pdIndex;
            var gdIndex;
            var oIndex;
            var check = function (id) {

                var ownedProduct = oIndex.getElementByKey(id);
                if (ownedProduct) return true;

                // if all bundled products are owned then bundle is owned
                if (Bundles.isParent(id)) {
                    var bundle = Bundles.getBundleByParentId(id);
                    var childProductsOwned = true;
                    for (var ii = 0; ii < bundle.children.length; ii++) {
                        childProductsOwned &= check(bundle.children[ii]);
                    }
                    if (childProductsOwned) return true;
                }

                var productData = pdIndex.getElementByKey(id);

                // return false because if that is not DLC, we should have passed the check earlier
                if (!DLC.isDLC(productData)) return false;

                for (var rp = 0; rp < productData.requiredProducts.length; rp++) {
                    var requiredProduct = productData.requiredProducts[rp].id;

                    var gameDetails = gdIndex.getElementByKey(requiredProduct);

                    if (!gameDetails ||
                      !gameDetails.dlcs) continue;

                    if (gameDetails.dlcs.length === 0) continue;

                    for (var dd = 0; dd < gameDetails.dlcs.length; dd++) {
                        var dlc = gameDetails.dlcs[dd];
                        if (dlc.title === productData.title) return true;
                    }
                }
            }
            var checkPartialOwnership = function (id) {
                if (Bundles.isParent(id) &&
                  Bundles.checkChildrenAny(id, check)) return true;
            }
            var init = function (pdi, gdi, oi) {
                pdIndex = pdi;
                gdIndex = gdi;
                oIndex = oi;
            }
            return {
                "check": check,
                "checkPartialOwnership": checkPartialOwnership,
                "init": init
            }
        }();

        var ProductClass = function () {
            var pdIndex, wIndex, uIndex;
            var getClass = function (product) {
                var productClass = [];

                if (Owned && Owned.check(product.id)) {
                    productClass.push("owned");
                } else if (owned &&
                  Owned.checkPartialOwnership &&
                  Owned.checkPartialOwnership(product.id)) {
                    productClass.push("partOwned");
                }

                if (wIndex.check(product.id)) productClass.push("wishlisted");
                if (uIndex.check(product.id)) productClass.push("updated");

                var pd = pdIndex.getElementByKey(product.id);
                if (pd && DLC.isDLC(pd)) productClass.push("dlc");

                if (Bundles.isParent(product.id)) productClass.push("bundle");

                return productClass;
            }
            var init = function (pdi, ui, wi) {
                pdIndex = pdi;
                wIndex = wi;
                uIndex = ui;
            }
            return {
                "init": init,
                "getClass": getClass
            }
        }();

        var ViewModelProvider = function () {
            var pdIndex, gdIndex, wIndex, uIndex;
            var getProductViewModel = function (product) {
                var productClass = ProductClass.getClass(product);
                return {
                    "id": product.id,
                    "productClass": productClass.join(" "),
                    "title": (DEBUG) ? product.title + " " + product.id : product.title
                };
            }
            var getRequiredProductViewModel = function (requiredProduct) {
                return requiredProduct;
            }
            var getDLCsViewModel = function (dlcs) {
                return {
                    "dlcContent": dlcs.join(""),
                    "dlcClass": dlcs.length ? "" : "hidden"
                }
            }
            var getBundleViewModel = function (bundles) {
                return {
                    "bundleContent": bundles.join(""),
                    "bundleClass": bundles.length ? "" : "hidden"
                }
            }
            var getGameDetailsViewModel = function (product) {

                var pd = pdIndex.getElementByKey(product.id);
                var gd = gdIndex.getElementByKey(product.id);

                var productClass = ProductClass.getClass(product).join(" ");

                var openFolderLink, openFolderClass = "hidden";
                if (!Bundles.isParent(product.id) &&
                    Owned.check(product.id) &&
                    product.slug) {
                    openFolderLink = product.slug;
                    openFolderClass = "";
                }

                var images, productImageClass = "hidden";
                if (product.image) {
                    if (product.image) images = Images.getRelativeUri(product.image);
                    if (images) productImageClass = "";
                }

                if (!images) {
                    images = {};
                }

                var productTitle = product.title;

                var developerTitle, developerClass = "hidden";
                if (pd &&
                    pd.developer &&
                    pd.developer.name) {
                    developerTitle = pd.developer.name;
                    if (developerTitle) developerClass = "";
                }

                var worksOnTitle, worksOnClass = "hidden";

                if (product.worksOn) {
                    var worksOn = [];
                    if (product.worksOn.Windows) worksOn.push("<svg viewBox='0 0 100 100'><use href='#windows'/></svg>");
                    if (product.worksOn.Mac) worksOn.push("<svg viewBox='0 0 100 100'><use href='#macosx'/></svg>");
                    if (product.worksOn.Linux) worksOn.push("<svg viewBox='0 0 100 100'><use href='#linux'/></svg>");

                    worksOnTitle = worksOn.join(" ");
                    if (worksOnTitle) worksOnClass = "";
                }

                var publisherTitle, publisherClass = "hidden";
                if (pd &&
                    pd.publisher &&
                    pd.publisher.name) {
                    publisherTitle = pd.publisher.name;
                    if (publisherTitle) publisherClass = "";
                }

                var seriesTitle, seriesClass = "hidden";

                if (pd &&
                    pd.series &&
                    pd.series.name) {
                    seriesTitle = pd.series.name;
                    if (seriesTitle) seriesClass = "";
                }

                var genresTitle, genresClass = "hidden";
                if (pd &&
                    pd.genres &&
                    pd.genres.length) {
                    var genres = [];
                    for (var ii = 0; ii < pd.genres.length; ii++) {
                        genres.push(pd.genres[ii].name);
                    }
                    genresTitle = genres.join(", ");
                    if (genresTitle) genresClass = "";
                }

                var cdKeyTitle, cdKeyClass = "hidden";
                var cdKeys = [];

                if (gd) {
                    if (gd.cdKey) {
                        cdKeys.push(gd.title + ": " + gd.cdKey);
                    }

                    if (gd.dlcs &&
                        gd.dlcs.length) {
                        for (var ii = 0; ii < gd.dlcs.length; ii++) {
                            if (gd.dlcs[ii].cdKey) {
                                cdKeys.push(gd.dlcs[ii].title + ": " + gd.dlcs[ii].cdKey);
                            }
                        }
                    }

                    cdKeyTitle = cdKeys.join(", ");

                    if (cdKeyTitle) cdKeyClass = "";
                }

                var requiredProductsTitle, requiredProductsClass = "hidden";
                if (pd &&
                    pd.requiredProducts &&
                    pd.requiredProducts.length) {
                    var requiredProducts = [];
                    for (var ii = 0; ii < pd.requiredProducts.length; ii++) {
                        var requiredProductView = Views.createView(pd.requiredProducts[ii],
                            getRequiredProductViewModel,
                            Templates.getRequiredProductTemplate);
                        requiredProducts.push(requiredProductView);
                    }
                    requiredProductsTitle = requiredProducts.join(", ");
                    if (requiredProductsTitle) requiredProductsClass = "";
                }

                return {
                    "openFolderLink": openFolderLink,
                    "openFolderClass": openFolderClass,
                    "productTitle": productTitle,
                    "productClass": productClass,
                    "productImage": images.productImage,
                    "productRetinaImage": images.productRetinaImage,
                    "productImageClass": productImageClass,
                    "worksOnTitle": worksOnTitle,
                    "worksOnClass": worksOnClass,
                    "developerTitle": developerTitle,
                    "developerClass": developerClass,
                    "publisherTitle": publisherTitle,
                    "publisherClass": publisherClass,
                    "seriesTitle": seriesTitle,
                    "seriesClass": seriesClass,
                    "cdKeyTitle": cdKeyTitle,
                    "cdKeyClass": cdKeyClass,
                    "genresTitle": genresTitle,
                    "genresClass": genresClass,
                    "requiredProductsTitle": requiredProductsTitle,
                    "requiredProductsClass": requiredProductsClass
                    //"dlcClass": dlcClass,
                    //"dlcContent": dlcContent
                }
            }
            var init = function (pdi, gdi, ui, wi) {
                pdIndex = pdi;
                gdIndex = gdi;
                wIndex = wi;
                uIndex = ui;
            }
            return {
                "init": init,
                "getProductViewModel": getProductViewModel,
                "getGameDetailsViewModel": getGameDetailsViewModel,
                "getDLCsViewModel": getDLCsViewModel,
                "getBundleViewModel": getBundleViewModel
            }
        }();

        var IndexedCollection = function () {
            var indexKeys = function (collection, getElementKey) {
                var index = [];
                collection.forEach(function (i) {
                    index[getElementKey(i)] = collection.indexOf(i);
                });
                return index;
            }
            var create = function (collection, getElementKey) {
                var index = indexKeys(collection, getElementKey);
                var getElementByKey = function (key) {
                    return collection[index[key]];
                }
                var getElementByIndex = function (itemIndex) {
                    return collection[itemIndex];
                }
                var check = function (id) {
                    if (Bundles &&
                      Bundles.isParent &&
                      Bundles.isParent(id) &&
                      Bundles.checkChildrenAny &&
                      Bundles.checkChildrenAny(id, check)) return true;

                    return getElementByKey(id) !== undefined;
                }
                return {
                    "getElementByKey": getElementByKey,
                    "getElementByIndex": getElementByIndex,
                    "check": check,
                    "getLength": function () {
                        return collection.length
                    }
                }
            }
            return {
                "create": create
            }
        }();

        var Bundles = function () {
            var parents = [];
            var children = [];
            var init = function () {
                if (!bundles || !bundles.length) return;
                for (var ii = 0; ii < bundles.length; ii++) {
                    parents.push(bundles[ii].parent);
                    for (var jj = 0; jj < bundles[ii].children.length; jj++) {
                        children.push(bundles[ii].children[jj]);
                    }
                }
            }
            var isParent = function (id) {
                return parents.indexOf(id) > -1;
            }
            var isChild = function (id) {
                return children.indexOf(id) > -1;
            }
            var getBundleByParentId = function (id) {
                for (var ii = 0; ii < bundles.length; ii++) {
                    if (bundles[ii].parent === id) {
                        return bundles[ii];
                    }
                }
            }
            var checkChildrenAny = function (id, predicate) {
                return checkChildrenInternal(id, predicate, false, function (a, b) {
                    return a | b;
                });
            }
            var checkChildrenAll = function (id, predicate) {
                return checkChildrenInternal(id, predicate, true, function (a, b) {
                    return a & b;
                });
            }
            var checkChildrenInternal = function (id, predicate, initialValue, comparison) {
                var bundle = getBundleByParentId(id);
                var result = initialValue;
                for (var ii = 0; ii < bundle.children.length; ii++) {
                    result = comparison(result, predicate(bundle.children[ii]));
                }
                return result;
            }
            return {
                "init": init,
                "isParent": isParent,
                "isChild": isChild,
                "getBundleByParentId": getBundleByParentId,
                "checkChildrenAny": checkChildrenAny,
                "checkChildrenAll": checkChildrenAll
            }
        }();

        document.addEventListener("DOMContentLoaded", function () {

            var getId = function (e) {
                return e.id
            };

            var getValue = function (e) {
                return e;
            }

            var start = new Date();
            var cp = [];
            var addedProducts = [];

            // first add available products...
            for (var ii = 0; ii < products.length; ii++) {
                cp.push(products[ii]);
                addedProducts.push(products[ii].id);
            }
            // ...then add owned products that are no longer available
            for (var ii = 0; ii < owned.length; ii++) {
                if (addedProducts.indexOf(owned[ii].id) > -1) continue;
                cp.push(owned[ii]);
            }

            var elapsed = new Date() - start;
            console.log("Combining products: " + elapsed + "ms");

            start = new Date();
            var productsIndex = IndexedCollection.create(cp, getId);
            var productsDataIndex = IndexedCollection.create(productsdata, getId);
            var gameDetailsIndex = IndexedCollection.create(gamedetails, getId);
            var ownedIndex = IndexedCollection.create(owned, getId);
            var updatedIndex = IndexedCollection.create(updated, getValue);
            var wishlistedIndex = IndexedCollection.create(wishlisted, getValue);

            ProductClass.init(productsDataIndex, updatedIndex, wishlistedIndex);
            ViewModelProvider.init(productsDataIndex, gameDetailsIndex, updatedIndex, wishlistedIndex);
            Owned.init(productsDataIndex, gameDetailsIndex, ownedIndex);
            elapsed = new Date() - start;
            console.log("Indexing collections: " + elapsed + "ms");

            start = new Date();
            Bundles.init();
            elapsed = new Date() - start;
            console.log("Initializing bundles: " + elapsed + "ms");

            start = new Date();
            var html = [];
            for (var ii = 0; ii < productsIndex.getLength() ; ii++) {
                var product = productsIndex.getElementByIndex(ii);

                if (Bundles.isChild(product.id)) continue;

                var view = Views.createView(product,
                  ViewModelProvider.getProductViewModel,
                  Templates.getProductTemplate);
                html.push(view);
            }
            elapsed = new Date() - start;
            console.log("Creating views: " + elapsed + "ms");

            var start = new Date();
            // show first N elements ASAP, others delay for a bit
            var throttle = Math.min(150, html.length);
            var initialHtml = html.slice(0, throttle).join("");
            var pContainer = document.getElementById("productsContainer");
            pContainer.innerHTML = initialHtml;

            var remainingHtml = html.slice(throttle, html.length).join("");
            requestAnimationFrame(function () {
                pContainer.innerHTML += remainingHtml;

                start = new Date();
                var productsElements = document.querySelectorAll("#productsContainer > .product");
                GameDetails.init(productsIndex, productsDataIndex, gameDetailsIndex);
                GameDetails.initElements(productsElements);
                elapsed = new Date() - start;
                console.log("Initializing game details: " + elapsed + "ms");
            });
            var elapsed = new Date() - start;
            console.log("Adding html to the DOM: " + elapsed + "ms");

            start = new Date();
            SearchIndex.init(
              productsIndex,
              productsDataIndex,
              ownedIndex,
              updatedIndex,
              wishlistedIndex);
            elapsed = new Date() - start;
            console.log("Initializing search index: " + elapsed + "ms");

            Search.init(productsIndex, productsDataIndex);
            var searchInput = $("searchInput");
            searchInput.addEventListener("input", function (e) {
                Search.search(searchInput.value.toLowerCase())
            });

            var showAllSearchResults = $("showAllSearchResults");
            showAllSearchResults.addEventListener("click", function () {
                Search.search(searchInput.value.toLowerCase(), true);
            });

            var toggleLegend = $("toggleLegend");
            toggleLegend.addEventListener("click", function (e) {
                var legendContainer = $("legendContainer");
                legendContainer.classList.toggle("hidden");
                e.preventDefault();
            });

            var backToTop = $("backToTop");
            backToTop.addEventListener("click", function () {
                var productsContainer = $("productsContainer");
                var searchResults = $("searchResults");

                if (!searchResults.classList.contains("hidden")) {
                    searchResults.scrollTop = 0;
                } else {
                    productsContainer.scrollTop = 0;
                }
            });
        });
    </script>
</body>

</html>
